<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Moi Space - Edit Profile</title>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
    />
    <link rel="stylesheet" href="/userProfile.css" />
    <style></style>
  </head>

  <body>
    <div class="app">
      <main class="content">
        <section class="profile-card">
          <div class="info">
            <div class="editable-photo" data-field="profile">
              <img
                class="profile-photo"
                data-field="profile"
                src='<% if(user.profileLink){%><%= user.profileLink%><% } else {%><%= "/mediafiles/roseFlower.jpg"%><%}%>'
                alt="profile-photo"
              />
              <span class="edit-icon" title="Change photo">✏️</span>
              <input type="file" accept="image/*" class="photo-input" hidden />
            </div>

            <div id="infos">
              <div class="change" id="profName"><%= user.username %></div>
              <input
                id="course"
                type="text"
                class="change"
                value="<% if(user.course){%><%= user.course%><% } else {%>Computer Science<%}%>"
              />
              <input
                id="year"
                type="text"
                class="change"
                value="<% if(user.year){%><%= user.year%><% } else {%>First year<%}%>"
              />
            </div><div id="outSet">
            <div id="insetA">views<span>20</span>followers<span>10</span></div>
            <div id="insetB">
            <button class="log-out"><a href="/logout">Log Out</a></button>
            <button class="log-out" id="Edit">Edit</button>
          </div></div>
        </section>

        <div class="slogan">
          <a onclick="window.history.back()"
            ><span class="material-symbols-outlined">arrow_back</span></a>
          <span contenteditable="true" id="sloganValue"
            ><% if(user.slogan){%><%= user.slogan%><% } else
            {%>Slogan!<%}%></span>
          <a href="/interests"
            ><span class="material-symbols-outlined">heart_check</span></a>
        </div>

        <section class="gallery">
          <div class="item" data-index="0" data-field="gallery">
            <img
              src='<% if(links && links[0]){%><%= links[0]%><% } else {%><%= "/mediafiles/darkgirl.jpg"%><%}%>'
              alt="gallery-0"
            />
            <span class="edit-icon" title="Change image">✏️</span>
            <input type="file" accept="image/*" class="photo-input" hidden />
          </div>
          <div class="item" data-index="1" data-field="gallery">
            <img
              src='<% if(links && links[1]){%><%= links[1]%><% } else {%><%= "/mediafiles/africanGirl.jpg"%><%}%>'
              alt="gallery-1"
            />
            <span class="edit-icon" title="Change image">✏️</span>
            <input type="file" accept="image/*" class="photo-input" hidden />
          </div>
          <div class="item" data-index="2" data-field="gallery">
            <img
              src='<% if(links && links[2]){%><%= links[2]%><% } else {%><%= "/mediafiles/darkishImagegirl.jpg"%><%}%>'
              alt="gallery-2"
            />
            <span class="edit-icon" title="Change image">✏️</span>
            <input type="file" accept="image/*" class="photo-input" hidden />
          </div>
        </section>
      </main>

      <div class="middles">
        <p class="desc-title">About Me</p>
        <textarea disabled class="desc-box" id="aboutMe">
<% if (user.aboutMe){%><%= user.aboutMe%><%} else {%>No changeges<%} %></textarea>
        
      </div>

      <div class="middles">
        <p class="desc-title">About You</p>
        <textarea disabled class="desc-box" id="aboutYou">
<% if (user.aboutYou){%><%= user.aboutYou%><%} else {%>No changes<%} %></textarea>
        
      </div>

      <button id="submit" class="anim">Save Profile Changes <div id="items" class=""><div id="insideBtn"></div><span id="saving">saving</span><div id="insideBtn"></div></div></button>
    </div>

    <script>
      const submitBtn = document.getElementById("submit");
      const savingSpan = document.getElementById("saving");
      let username = localStorage.getItem("mainUser") || "<%= user.username %>";
      const changedImages = [];
      const changedFields = {};
      document
        .querySelectorAll(".item, .editable-photo")
        .forEach((container) => {
          const editIcon = container.querySelector(".edit-icon");
          const fileInput = container.querySelector(".photo-input");
          const img = container.querySelector("img");

          const field =
            container.dataset.field ||
            img.dataset.field ||
            (img.alt && img.alt.includes("profile") ? "profile" : "gallery");
          const index =
            container.dataset.index !== undefined
              ? parseInt(container.dataset.index, 10)
              : null;

          editIcon?.addEventListener("click", () => {
            fileInput.click();
          });

          fileInput?.addEventListener("change", (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
              img.src = ev.target.result;
            };
            reader.readAsDataURL(file);

            if (field === "profile") {
              const idx = changedImages.findIndex(
                (ci) => ci.field === "prof" && ci.index === null
              );
              const obj = { field: "prof", index: null, file };
              if (idx >= 0) changedImages[idx] = obj;
              else changedImages.push(obj);
            } else {
              const idx = changedImages.findIndex(
                (ci) => ci.field === "gallery" && ci.index === index
              );
              const obj = { field: "gallery", index, file };
              if (idx >= 0) changedImages[idx] = obj;
              else changedImages.push(obj);
            }

            console.log("changedImages:", changedImages);
          });
        });

      let aboutMeBox = document.getElementById("aboutMe");
      let aboutYouBox = document.getElementById("aboutYou");
      let courseInput = document.getElementById("course");
      let yearInput = document.getElementById("year");
      let sloganSpan = document.getElementById("sloganValue");
      function computeChangedText() {
        const changed = {};

        let aboutMeVal = aboutMeBox.value.trim();
        let aboutYouVal = aboutYouBox.value.trim();
        let courseVal = courseInput.value.trim();
        let yearVal = yearInput.value.trim();
        let sloganVal = sloganSpan.innerText.trim();

        if (aboutMeBox.dataset.modified === "true")
          changed.aboutMe = aboutMeVal;
        if (aboutYouBox.dataset.modified === "true")
          changed.aboutYou = aboutYouVal;
        if (courseInput.dataset.modified === "true") changed.course = courseVal;
        if (yearInput.dataset.modified === "true") changed.year = yearVal;
        if (sloganSpan.dataset.modified === "true") changed.slogan = sloganVal;

        return changed;
      }

      [aboutMeBox, aboutYouBox, courseInput, yearInput].forEach((el) => {
        el.addEventListener("input", () => (el.dataset.modified = "true"));
      });
      sloganSpan.addEventListener(
        "input",
        () => (sloganSpan.dataset.modified = "true")
      );

      async function uploadChangedImages() {
        if (changedImages.length === 0)
          return { ok: true, message: "no images changed" };

        const formData = new FormData();
        formData.append("username", username);

        for (const ci of changedImages) {
          if (ci.field === "prof") {
            formData.append(`prof_main`, ci.file);
          } else if (ci.field === "gallery") {
            formData.append(`gallery_${ci.index}`, ci.file);
          }
        }

        const res = await fetch("/profile/update/pics", {
          method: "POST",
          body: formData,
        });

        const data = await res.json();
        return data;
      }
      async function updateChangedText() {
        const changed = computeChangedText();
        if (Object.keys(changed).length === 0)
          return { ok: true, message: "no text changed" };

        changed.username = username;

        const res = await fetch("/profile/update/text", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(changed),
        });
        const data = await res.json();
        return data;
      }

      submitBtn.addEventListener("click", async () => {
          const submitBn = document.getElementById("submit")
          const items = document.getElementById("items")
          const edits = document.querySelectorAll('.edit-icon')
          edits.forEach((edit)=>{
          edit.classList.add('unhide')
        })
        const promises = [];
        if (changedImages.length > 0) promises.push(uploadChangedImages());
        if (
          aboutMeBox.dataset.modified === "true" ||
          aboutYouBox.dataset.modified === "true" ||
          courseInput.dataset.modified === "true" ||
          yearInput.dataset.modified === "true" ||
          sloganSpan.dataset.modified === "true"
        ) {
          promises.push(updateChangedText());
        }

        if (promises.length === 0) {
          alert("Make atleast 1 change to update.");
        } else {
          submitBn.classList.add('anim')
          items.style.display = 'flex'
          const results = await Promise.all(promises);
          document.getElementById('submit').style.display = 'none'
          document.querySelectorAll('.desc-box').forEach((item)=>{
          item.disabled = true});
          edits.forEach((edit)=>{
          edit.classList.remove('unhide')
          });
          alert(results.map((r) => r.message || JSON.stringify(r)).join("\n"));
          submitBn.classList.remove('anim')
          items.style.display = 'none'
          changedImages.length = 0;
          [aboutMeBox, aboutYouBox, courseInput, yearInput].forEach(
            (el) => (el.dataset.modified = "false")
          );
          sloganSpan.dataset.modified = "false";
        }
      });
      const textareas = document.querySelectorAll(".desc-box");
      textareas.forEach((t) => {
        t.style.height = t.scrollHeight + "px";
        t.addEventListener("input", () => {
          t.style.height = "auto";
          t.style.height = t.scrollHeight + "px";
        });
      });
      document.getElementById('Edit').addEventListener('click',()=>{
        const edits = document.querySelectorAll('.edit-icon')
        edits.forEach((edit)=>{
          edit.classList.add('unhide')
        })
        document.getElementById('submit').style.display = 'flex'
        document.querySelectorAll('.desc-box').forEach((item)=>{
          item.disabled = false
        })
      })
    </script>
  </body>
</html>
